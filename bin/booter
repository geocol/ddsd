#!/bin/bash
set -eo pipefail

#!/bin/bash

if ! curl --version > /dev/null; then
  if apt-get --version > /dev/null; then
    sh -c 'apt-get update && apt-get install -y curl'
  else
    echo "curl not found"
    exit 1
  fi
fi

if ! perl --version > /dev/null; then
  if yum --version > /dev/null; then
    su -c 'yum install -y perl'
  else
    echo "perl not found"
    exit 1
  fi
fi

(mkdir local 2> /dev/null || true) && (mkdir local/bin 2> /dev/null || true) && \
curl -sSLf https://raw.githubusercontent.com/wakaba/perl-setupenv/master/bin/pmbp.pl > local/bin/pmbp.pl.new && \
perl -c local/bin/pmbp.pl.new 2> /dev/null && \
mv local/bin/pmbp.pl.new local/bin/pmbp.pl


perl local/bin/pmbp.pl --install-commands "make git wget"

mkdir -p local/ddsd
(git clone -b master --depth 1 https://github.com/geocol/ddsd local/ddsd/app) || \
(cd local/ddsd/app && git pull --depth 1 --rebase && (git checkout -b master || git checkout master) && git pull --depth 1 --rebase)

cd local/ddsd/app
make deps-booter
cd ../../../
cp local/ddsd/app/ddsd ./

echo ddsd is ready.
echo Run:
echo   \$ ./ddsd

## License: Public Domain.
